<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
    <title>Basic anomaly statistics for a system trace</title>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="http://billmill.org/css/style.css" />
    <link rel="stylesheet" type="text/css" href="style.css">

</head>
<body>

<div id="datatable"></div>

<script>

    d3.json("data.json",function(error,json){
        if (error) return console.warn(error);
        var table = d3.select("#datatable").append("table");
        var thead = table.append("thead");
        var tbody = table.append("tbody");

        var width = 300,
                height = d3.select("table")[0][0].clientHeight,
                mx = 10;

        // Now add the chart column
        //thead.append("th").text("");
        d3.select("#datatable thead").append("th")
                .attr("id", "xaxislabel")
                .attr("width", width + "px");
        thead.append("th").text("eventA");
        thead.append("th").text("eventB");
        thead.append("th").text("sig");
        thead.append("th").text("result");
        thead.append("th").text("low");
        thead.append("th").text("high");

        var tr = tbody.selectAll("tr")
                .data(json)
                .enter().append("tr");
        d3.selectAll("#datatable tbody tr").append("td")
                .attr("id", "chart")
                .attr("width", width + "px");

        var chart = d3.selectAll("#chart").append("svg")

                .attr("width", width+ "px")
                .attr("height", 30+ "px");

        var td = tr.selectAll("td")
                .data(function(d) { return ['',d.eventA, d.eventB, d.sig, d.result, d.low, d.high]; })
                .enter().append("td")
                .text(function(d) { return d; });
        var maxData,minData,meanPos,maxWidth;
        var sdSpan=[],
            labelPosArr=[],
            maxArr=[],
            minArr =[];

        json.forEach(function(element,index,array){
            var max = Math.max(element.result,element.high);
            var min = Math.min(element.result,element.low);
            maxArr.push(max);
            minArr.push(min);
            sdSpan.push(d3.round((element.mean - min)/element.sd));
            sdSpan.push(d3.round((max -element.mean)/element.sd));
        });
        maxData = d3.max(maxArr);
        minData = d3.min(minArr);
        meanPos = (maxData+minData)*0.5;
        labelPosArr.push(meanPos);//push mean pos into array
        maxWidth =d3.round((maxData-meanPos)/d3.max(sdSpan));
        for(var i = 1; i < 4; ++i)
        {
            labelPosArr.unshift(d3.round(meanPos - i * maxWidth));
        }
        for(var i= 1; i < 4;++i)
        {
            labelPosArr.push(d3.round(meanPos+i*maxWidth));
        }
        var xscale = d3.scale.linear()
                .domain([minData,maxData])
                .range([0, 300]);
        var tickLabels = ['3'+'\u03c3','2'+'\u03c3','\u03c3','\u03BC','\u03c3','2'+'\u03c3','3'+'\u03c3'];
        var xAxis = d3.svg.axis()
                        .scale(xscale)
                        .orient("top")
                        .tickValues(labelPosArr)
                        .tickSize(2,0)
                    .tickFormat(function(d,i){ return tickLabels[i] });
        d3.select("#xaxislabel").append("svg")
                                    .attr("width", width+ "px")
                                    .attr("height",30+ "px")
        .append("g").attr("class", "axis")
                .attr("width", width+ "px")
                .attr("height",30+ "px")
                .attr("transform", "translate(0,30)")
                .call(xAxis);

//        chart.selectAll(".xaxistick")
//                .data(xscale.ticks(2))
//                .enter().append("line")
//                .attr("x1", function(d) { return xscale(d); })
//                .attr("x2", function(d) { return xscale(d); })
//                .attr("y1", 10)
//                .attr("y2", height)
//                .attr("stroke", "#eee")
//                .attr("stroke-width", 1);

//        chart.selectAll(".line")
//                .data(json)
//                .enter().append("line")
//                .attr("x1", function(d) { return xscale(d.mu); })
//                .attr("y1", function(d) { return yscale(d.dt) + yscale.rangeBand()/2; })
//                .attr("x2", function(d,i) { return rows[i+1] ? xscale(rows[i+1].mu) : xscale(d.mu); })
//                .attr("y2", function(d,i) { return rows[i+1] ? yscale(rows[i+1].dt) + yscale.rangeBand()/2 : yscale(d.dt) + yscale.rangeBand()/2; })
//                .attr("stroke", "#777")
//                .attr("stroke-width", 1);
//
//        var pt = chart.selectAll(".pt")
//                .data(rows)
//                .enter().append("g")
//                .attr("class", "pt")
//                .attr("transform", function(d) { return "translate(" + xscale(d.mu) + "," + (yscale(d.dt) + yscale.rangeBand()/2) + ")"; });
//
//        pt.append("circle")
//                .attr("cx", 0)
//                .attr("cy", 0)
//                .attr("r", radius)
//                .attr("opacity", .5)
//                .attr("fill", "#ff0000");

    });







</script>
</body>
</html>
